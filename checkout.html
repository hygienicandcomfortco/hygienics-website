<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Checkout | Hygienic & Comfort Co.</title>

<link href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@400;600;700;800&display=swap" rel="stylesheet">
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
<script src="https://unpkg.com/lucide@latest"></script>

<style>
:root {
--primary: #2563eb;
--dark: #1e293b;
--grey: #64748b;
--bg: #f8fafc;
}
* { margin: 0; padding: 0; box-sizing: border-box; }
body {
font-family: 'Plus Jakarta Sans', 'Noto Sans', 'Segoe UI', 'Segoe UI Symbol', sans-serif;
background: var(--bg);
color: var(--dark);
padding: 20px;
}
.checkout-container {
max-width: 600px;
margin: auto;
background: white;
padding: 30px;
border-radius: 20px;
box-shadow: 0 10px 15px rgba(0,0,0,0.05);
}
h2 { margin-bottom: 20px; font-weight: 800; }
.order-summary {
background: #f1f5f9;
padding: 15px;
border-radius: 12px;
margin-bottom: 25px;
}
.order-items {
display: flex;
flex-direction: column;
gap: 12px;
margin-top: 8px;
}
.order-item {
background: #fff;
border: 1px solid #e2e8f0;
border-radius: 12px;
padding: 10px;
display: flex;
align-items: flex-start;
gap: 10px;
}
.order-item img {
width: 56px;
height: 56px;
object-fit: cover;
border-radius: 10px;
border: 1px solid #e2e8f0;
background: #fff;
}
.order-item-body {
flex: 1;
}
.order-items .item-name {
line-height: 1.35;
font-weight: 800;
font-size: 0.9rem;
}
.order-item-meta {
display: flex;
justify-content: space-between;
align-items: center;
margin-top: 6px;
gap: 8px;
}
.order-items .item-qty {
font-size: 0.78rem;
color: #475569;
}
.order-items .item-unit {
font-size: 0.78rem;
color: #64748b;
}
.order-items .item-total {
font-size: 0.9rem;
font-weight: 800;
color: #0f172a;
white-space: nowrap;
}
.order-totals {
border-top: 1px dashed #cbd5e1;
margin-top: 12px;
padding-top: 10px;
}
.order-totals p {
display: flex;
justify-content: space-between;
font-size: 0.85rem;
margin-top: 4px;
}
.order-totals .grand-total {
font-size: 1.15rem;
font-weight: 800;
color: #2563eb;
margin-top: 8px;
}
.form-group { margin-bottom: 15px; }
.form-row { display: grid; grid-template-columns: 1fr 1fr; gap: 15px; margin-bottom: 15px; }
label {
display: block;
font-size: 0.8rem;
font-weight: 800;
text-transform: uppercase;
color: var(--grey);
margin-bottom: 8px;
}
input, textarea, select {
width: 100%;
padding: 14px;
border-radius: 12px;
border: 1.5px solid #e2e8f0;
font-family: inherit;
outline: none;
}

.address-list {
display: flex;
flex-direction: column;
gap: 12px;
margin-bottom: 20px;
}
.address-dropdown { position: relative; margin-bottom: 20px; }
.address-select {
width: 100%;
background: #fff;
border: 1px solid #e2e8f0;
border-radius: 12px;
padding: 12px 14px;
display: flex;
align-items: flex-start;
justify-content: space-between;
gap: 10px;
cursor: pointer;
font-weight: 700;
font-size: 0.85rem;
color: var(--dark);
text-align: left;
}
#selected-address-text { flex: 1; line-height: 1.25; }
.address-select .addr-caret { transition: transform 0.2s ease; }
.address-dropdown.open .address-select .addr-caret { transform: rotate(180deg); }
.address-dropdown .address-list { display: none; margin-top: 10px; }
.address-dropdown.open .address-list { display: flex; }
.address-card {
border: 2px solid #e2e8f0;
padding: 15px;
border-radius: 12px;
cursor: pointer;
position: relative;
transition: 0.2s;
}
.address-card.selected {
border-color: var(--primary);
background: #eff6ff;
}
.address-card .badge {
font-size: 0.6rem;
font-weight: 800;
background: #e2e8f0;
padding: 3px 8px;      border-radius: 5px;
text-transform: uppercase;
margin-bottom: 5px;
display: inline-block;
}
.address-card.selected .badge { background: var(--primary); color: white; }
.address-card p { font-size: 0.85rem; line-height: 1.4; color: var(--dark); }
.address-card .recipient { font-weight: 800; margin-bottom: 2px; display: block;}

.payment-method {
border: 2px solid #16a34a;
padding: 15px;
border-radius: 12px;
display: flex;
align-items: center;
gap: 10px;
background: #f0fdf4;
margin-top: 20px;
}
.confirm-btn {
width: 100%;
background: var(--primary);
color: white;
padding: 18px;
border: none;
border-radius: 15px;
font-weight: 800;
font-size: 1rem;
cursor: pointer;
margin-top: 30px;
}
.back-link {
display: block;
text-align: center;
margin-top: 15px;
color: var(--grey);
text-decoration: none;
font-weight: 600;
font-size: 0.9rem;
}
.hidden { display: none; }
    .site-footer {
      margin-top: 40px;
      padding: 28px 20px;
      background: linear-gradient(180deg, #f8fbff 0%, #eef4ff 100%);
      border-top: 1px solid #dbe7ff;
      text-align: center;
    }
    .site-footer .footer-inner {
      max-width: 1100px;
      margin: 0 auto;
    }
    .site-footer .footer-nav {
      display: flex;
      flex-wrap: wrap;
      justify-content: center;
      gap: 14px 18px;
      margin-bottom: 12px;
    }
    .site-footer .footer-nav a {
      color: #2563eb;
      text-decoration: none;
      font-size: 0.9rem;
      font-weight: 700;
      letter-spacing: 0.1px;
    }
    .site-footer .footer-nav a:hover {
      color: #1d4ed8;
      text-decoration: underline;
      text-underline-offset: 2px;
    }
    .site-footer .footer-contact {
      margin: 0 0 6px 0;
      color: #64748b;
      font-size: 0.86rem;
      line-height: 1.5;
    }
    .site-footer .footer-contact a {
      color: #2563eb;
      text-decoration: none;
      font-weight: 600;
    }
    .site-footer .footer-contact a:hover {
      text-decoration: underline;
      text-underline-offset: 2px;
    }
    .site-footer .footer-copy {
      margin: 4px 0 0 0;
      color: #64748b;
      font-size: 0.82rem;
    }
  </style>
</head>
<body>

<div class="checkout-container">
<h2>Complete Your Order</h2>

<div class="order-summary" id="order-summary"></div>

<form id="checkout-form">
<label for="address-select">Select Delivery Address</label>
<div class="address-dropdown" id="address-dropdown">
<button type="button" class="address-select" id="address-select">
<span id="selected-address-text">Select address</span>
<i data-lucide="chevron-down" class="addr-caret" style="width: 16px;"></i>
</button>
<div class="address-list" id="address-list">
<p style="font-size: 0.8rem; color: var(--grey);">Loading addresses...</p>
</div>
</div>

<div id="new-address-form" class="hidden" style="border: 1px dashed #cbd5e1; padding: 20px; border-radius: 15px; margin-bottom: 20px; background: #fafafa;">
<p style="font-weight: 800; font-size: 0.85rem; margin-bottom: 15px; color: var(--dark);">ENTER NEW DELIVERY ADDRESS</p>
<div class="form-group">
<label for="new-full-name">Full Name</label>
<input type="text" id="new-full-name" placeholder="Enter recipient name">
</div>

<div class="form-group">
<label for="new-mobile">Mobile Number</label>
<input type="tel" id="new-mobile" maxlength="10" placeholder="10-digit mobile number">
</div>

<div class="form-row">
<div class="form-group">
<label for="new-pincode">Pincode</label>
<input type="text" id="new-pincode" maxlength="6" placeholder="6 digits">
</div>
<div class="form-group">
<label for="new-city">Town/City</label>
<input type="text" id="new-city" placeholder="City name">
</div>
</div>

<div class="form-group">
<label for="new-flat">Flat, House no., Building</label>
<input type="text" id="new-flat" placeholder="Flat/House number">
</div>

<div class="form-group">
<label for="new-area">Area, Street, Sector</label>
<input type="text" id="new-area" placeholder="Area / Street / Sector">
</div>

<div class="form-row">
<div class="form-group">
<label for="new-state">State</label>
<input type="text" id="new-state" placeholder="State">
</div>
<div class="form-group">
<label for="new-addr-type">Address Type</label>
<select id="new-addr-type">
<option value="Home">Home</option>
<option value="Office">Office</option>
<option value="Other">Other</option>
</select>
</div>
</div>

<div style="display: flex; align-items: center; gap: 8px; margin-top: 10px;">
<input type="checkbox" id="save-to-profile" style="width: auto;" checked>
<label for="save-to-profile" style="text-transform: none; margin-bottom: 0; font-weight: 600;">Save this address to my profile</label>
</div>
</div>

<div class="form-group">
<label for="cust-alt-phone">Alternate Mobile (Optional)</label>
<input type="tel" id="cust-alt-phone" maxlength="10" placeholder="Secondary contact number">
</div>

<p style="display:block;font-size:0.8rem;font-weight:800;text-transform:uppercase;color:var(--grey);margin-bottom:8px;">Payment Method</p>
<div class="payment-method">
<i data-lucide="banknote" style="color: #16a34a"></i>
<div>
<p style="font-weight:800; font-size:0.9rem;">Cash on Delivery (COD)</p>
<p style="font-size:0.75rem; color:var(--grey);">Pay when you receive the product</p>
</div>
</div>

<button type="submit" class="confirm-btn" id="confirm-btn">Confirm Order</button>
</form>

<a href="products.html" class="back-link">Cancel and Go Back</a>
</div>

<script>
const SUPABASE_URL = "https://uhkheprfbxxwuojswyht.supabase.co";
const SUPABASE_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InVoa2hlcHJmYnh4d3VvanN3eWh0Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3Njc1MjQ4NTMsImV4cCI6MjA4MzEwMDg1M30.sm7ZhqVDWWckAolZN_7p3cGMaK0_aOnwgQcPXnUA-Es";
const supa = supabase.createClient(SUPABASE_URL, SUPABASE_KEY);
const RUPEE = "&#8377;";

async function blockAdminFromCustomerSite() {
  const { data: { user } } = await supa.auth.getUser();
  if (!user) return null;

  const { data: profile } = await supa
    .from('profiles')
    .select('role')
    .eq('id', user.id)
    .single();

  if (!profile) return null;

  if (profile.role === 'admin' || profile.role === 'staff') {
    await supa.auth.signOut();
    alert("Admin accounts must login from Admin Panel.");
    window.location.href = "login.html";
    throw new Error("Admin blocked from customer site");
  }

  return profile;
}

(async () => {
  await blockAdminFromCustomerSite();
})();

async function placeOrder(cartItems, totalAmount, customerName) {
  const { data: { user } } = await supa.auth.getUser();
  await blockAdminFromCustomerSite();

  if (!user) {
    alert("Please login first");
    return null;
  }

  const { data: order, error: orderError } = await supa
    .from("orders")
    .insert([{
      user_id: user.id,
      customer_name: customerName,
      status: "New",
      items: cartItems.map(i => i.name).join(", "),
      total_price: totalAmount
    }])
    .select()
    .single();

  if (orderError) {
    console.error(orderError);
    alert("Order failed");
    return null;
  }

  const orderId = order.id;

  const orderItemsData = cartItems.map(item => ({
    order_id: orderId,
    product_id: item.id,
    quantity: item.qty || item.quantity || 1,
    unit_price: item.price
  }));

  const { error: itemsError } = await supa
    .from("order_items")
    .insert(orderItemsData);

  if (itemsError) {
    console.error(itemsError);
    alert("Order items failed");
    return null;
  }

  alert("Order placed successfully ðŸŽ‰");
  return orderId;
}

let selectedAddressText = "";
let isManualMode = false;
let profileName = "";
let profilePhone = "";
let resolvedCustomerId = null;

function setManualAddressRequired(enabled) {
const ids = [
'new-full-name',
'new-mobile',
'new-pincode',
'new-city',
'new-flat',
'new-area',
'new-state'
];
ids.forEach((id) => {
const el = document.getElementById(id);
if (el) el.required = !!enabled;
});
}

function escapeHtml(value = "") {
return value
.replace(/&/g, "&amp;")
.replace(/</g, "&lt;")
.replace(/>/g, "&gt;")
.replace(/"/g, "&quot;")
.replace(/'/g, "&#39;");
}

function sanitizeValue(value) {
const text = (value ?? "").toString().trim();
if (!text || text.toLowerCase() === "null" || text.toLowerCase() === "undefined") return "";
return text;
}

function normalizeText(value) {
return sanitizeValue(value).replace(/\s+/g, " ").toLowerCase();
}

function formatAddress(addr = {}) {
const base = [addr.full_address, addr.city, addr.state].map(sanitizeValue).filter(Boolean).join(", ");
const pin = sanitizeValue(addr.pincode);
if (base && pin) return `${base} - ${pin}`;
if (base) return base;
if (pin) return pin;
return "Address not available";
}

function getSummaryItems(data) {
if (Array.isArray(data.cartItems) && data.cartItems.length > 0) {
return data.cartItems.map((item) => ({
name: sanitizeValue(item.name || item.product_name || "Item"),
qty: Math.max(1, Number(item.qty) || 1),
price: Math.max(0, Number(item.price) || 0),
image: sanitizeValue(item.images?.[0] || item.image || "logo.png")
}));
}

return [{
name: sanitizeValue(data.name || data.itemsText || "Item"),
qty: 1,
price: Math.max(0, Number(data.price) || 0),
image: sanitizeValue(data.image || "logo.png")
}];
}

async function resolveCustomerId(user) {
if (!user?.id) return null;

// 1) Reuse any customer_id from this user's previous orders.
try {
const { data: prevOrder } = await supa
.from('orders')
.select('customer_id')
.eq('user_id', user.id)
.not('customer_id', 'is', null)
.order('created_at', { ascending: false })
.limit(1)
.maybeSingle();
if (prevOrder?.customer_id) return prevOrder.customer_id;
} catch (e) {
console.warn("Could not read previous order customer_id:", e);
}

// 2) Try direct lookup in customers table by user/email/phone if allowed.
try {
let query = supa.from('customers').select('id').eq('user_id', user.id).limit(1);
let { data: byUser } = await query;
if (Array.isArray(byUser) && byUser[0]?.id) return byUser[0].id;
} catch (e) {
console.warn("customers lookup by user_id failed:", e);
}

if (user.email) {
try {
const { data: byEmail } = await supa.from('customers').select('id').eq('email', user.email).limit(1);
if (Array.isArray(byEmail) && byEmail[0]?.id) return byEmail[0].id;
} catch (e) {
console.warn("customers lookup by email failed:", e);
}
}

if (user.phone) {
try {
const { data: byPhone } = await supa.from('customers').select('id').eq('phone_number', user.phone).limit(1);
if (Array.isArray(byPhone) && byPhone[0]?.id) return byPhone[0].id;
} catch (e) {
console.warn("customers lookup by phone failed:", e);
}
}

return null;
}

async function ensureCustomerId(user) {
  if (!user?.id) return null;

  /* -------------------------------------------------
     STEP 0 â€” CHECK IF USER IS ADMIN
     Admins must NEVER become customers
  --------------------------------------------------*/
  const { data: roleRow } = await supa
    .from("user_roles")
    .select("role")
    .eq("id", user.id)
    .maybeSingle();

  if (roleRow?.role === "admin") {
    console.log("Admin detected â€” skipping customer creation");
    return null;   // ðŸš« STOP HERE FOR ADMINS
  }

  /* -------------------------------------------------
     STEP 1 â€” Try find existing customer
  --------------------------------------------------*/
  const existingId = await resolveCustomerId(user);
  if (existingId) return existingId;

  /* -------------------------------------------------
     STEP 2 â€” Create customer ONLY for real customers
  --------------------------------------------------*/
  const candidateName =
    profileName ||
    user.user_metadata?.full_name ||
    "Customer";

  const candidatePhone = profilePhone || user.phone || null;

  const { data: inserted, error } = await supa
    .from("customers")
    .insert([{
      user_id: user.id,
      customer_name: candidateName,
      email: user.email || null,
      phone_number: candidatePhone
    }])
    .select("id")
    .maybeSingle();

  if (error) {
    console.warn("Customer insert failed:", error);
    return null;
  }

  return inserted?.id || null;
}

// 1. Load the Product from LocalStorage
const checkoutData = JSON.parse(localStorage.getItem('checkout-item'));
if (!checkoutData) {
alert("Checkout session expired.");
location.href = "products.html";
}

// 2. Display Order Summary
const summaryItems = getSummaryItems(checkoutData);
const itemsSubtotal = summaryItems.reduce((sum, item) => sum + (Number(item.price) * Number(item.qty || 1)), 0);
const grandTotal = Math.max(0, Number(checkoutData.price) || 0);
const deliveryFee = Math.max(0, grandTotal - itemsSubtotal);
const summaryHtml = summaryItems.length
? `<div class="order-items">
${summaryItems.map((item) => {
const qty = Math.max(1, Number(item.qty) || 1);
const unit = Math.max(0, Number(item.price) || 0);
const lineTotal = unit * qty;
return `<div class="order-item">
<img src="${escapeHtml(item.image || "logo.png")}" alt="${escapeHtml(item.name)}" onerror="this.src='logo.png'">
<div class="order-item-body">
<div class="item-name">${escapeHtml(item.name)}</div>
<div class="order-item-meta">
<div>
<div class="item-qty">Qty: ${qty}</div>
<div class="item-unit">Unit: Rs. ${unit.toLocaleString('en-IN')}</div>
</div>
<div class="item-total">${RUPEE}${lineTotal.toLocaleString('en-IN')}</div>
</div>
</div>
</div>`;
}).join("")}
</div>`
: `<p style="font-weight:800;">${escapeHtml(sanitizeValue(checkoutData.itemsText || checkoutData.name || "Item"))}</p>`;
document.getElementById('order-summary').innerHTML = `
   <p style="font-size:0.75rem; color:#64748b;">ORDERING:</p>
   ${summaryHtml}
   <div class="order-totals">
   <p><span>Items Total</span><span>${RUPEE}${itemsSubtotal.toLocaleString('en-IN')}</span></p>
   ${deliveryFee > 0 ? `<p><span>Delivery</span><span>${RUPEE}${deliveryFee.toLocaleString('en-IN')}</span></p>` : ""}
   <p class="grand-total"><span>Total</span><span>${RUPEE}${grandTotal.toLocaleString('en-IN')}</span></p>
   </div>
`;

// 3. Load Saved Data on Page Load
async function loadCheckoutData() {
const { data: { user } } = await supa.auth.getUser();
await blockAdminFromCustomerSite();
if (!user) { location.href = "login.html"; return; }
resolvedCustomerId = await ensureCustomerId(user);

// Load Profile Name/Phone
    // Get user profile from customers table instead
    const { data: profile } = await supa
      .from('customers')
      .select('*')
      .eq('user_id', user.id)
      .maybeSingle();
    if (profile) {
      profileName = profile?.customer_name || "";
      profilePhone = profile?.phone_number || "";
      document.getElementById('cust-alt-phone').value = profile?.phone_number || "";
    }

// Load Addresses Cards
const { data: rawAddresses } = await supa.from('customer_addresses').select('*').eq('user_id', user.id);
const listDiv = document.getElementById('address-list');
const selectedText = document.getElementById('selected-address-text');
const dropdown = document.getElementById('address-dropdown');
listDiv.innerHTML = "";

const addresses = (rawAddresses || []).filter((addr) => sanitizeValue(addr.user_id) === sanitizeValue(user.id));
if (addresses && addresses.length > 0) {
const preferredAddressId = sanitizeValue(checkoutData?.selectedAddressId);
const preferredAddressLabel = normalizeText(checkoutData?.selectedAddressText);
let selectedIndex = -1;

if (preferredAddressId) {
selectedIndex = addresses.findIndex((addr) => sanitizeValue(addr.id) === preferredAddressId);
}

if (selectedIndex < 0 && preferredAddressLabel && preferredAddressLabel !== "use a different pincode") {
selectedIndex = addresses.findIndex((addr) => {
const recipient = sanitizeValue(addr.full_name || addr.recipient_name || "");
const label = `${recipient} ${formatAddress(addr)}`.trim();
return normalizeText(label) === preferredAddressLabel;
});
}

if (selectedIndex < 0) selectedIndex = 0;

addresses.forEach((addr, index) => {
const fullAddrStr = formatAddress(addr);
const card = document.createElement('div');
const isSelected = index === selectedIndex;
card.className = `address-card ${isSelected ? 'selected' : ''}`;
if (isSelected) selectedAddressText = fullAddrStr;

const badgeText = (addr.type || addr.address_type || "Address").toString();
const recipientName = (addr.full_name || addr.recipient_name || "").toString();
card.innerHTML = `<span class="badge">${badgeText}</span><p><b>${recipientName}</b> ${fullAddrStr}</p>`;
card.onclick = () => {
document.querySelectorAll('.address-card').forEach(c => c.classList.remove('selected'));
card.classList.add('selected');
selectedAddressText = fullAddrStr;
if (selectedText) selectedText.innerText = `${recipientName} ${fullAddrStr}`.trim();
isManualMode = false;
setManualAddressRequired(false);
document.getElementById('new-address-form').classList.add('hidden');
if (dropdown) dropdown.classList.remove('open');
};
listDiv.appendChild(card);
if (isSelected && selectedText) {
selectedText.innerText = `${recipientName} ${fullAddrStr}`.trim();
}
});
}

// New Address Button
const newBtn = document.createElement('div');
newBtn.className = "address-card";
newBtn.innerHTML = `<p style="color:var(--primary); font-weight:700;">+ Use a new delivery address</p>`;
newBtn.onclick = () => {
document.querySelectorAll('.address-card').forEach(c => c.classList.remove('selected'));
newBtn.classList.add('selected');
isManualMode = true;
setManualAddressRequired(true);
if (selectedText) selectedText.innerText = "Use a new delivery address";
document.getElementById('new-address-form').classList.remove('hidden');
if (dropdown) dropdown.classList.remove('open');
};
listDiv.appendChild(newBtn);
setManualAddressRequired(false);
}

// 4. Handle Final Form Submission
document.getElementById('checkout-form').addEventListener('submit', async (e) => {
e.preventDefault();
const btn = document.getElementById('confirm-btn');
const { data: { user } } = await supa.auth.getUser();
await blockAdminFromCustomerSite();

if (!user) {
alert("Please login again to place the order.");
window.location.href = "login.html";
return;
}

let finalAddress = "";

try {
btn.disabled = true;
btn.innerText = "Processing...";

// Ensure we have a valid customers.id for RLS policies that check customer ownership.
resolvedCustomerId = await ensureCustomerId(user);
if (!resolvedCustomerId) {
throw new Error("Customer profile is missing. Please open Profile once and try again.");
}

// PHASE 1: Handle Manual Address Save
if (isManualMode) {
const manualName = document.getElementById('new-full-name').value.trim();
const pin = document.getElementById('new-pincode').value.trim();
const city = document.getElementById('new-city').value.trim();
const flat = document.getElementById('new-flat').value.trim();
const area = document.getElementById('new-area').value.trim();
const state = document.getElementById('new-state').value.trim();
const type = document.getElementById('new-addr-type').value;

const manualMobile = document.getElementById('new-mobile').value.trim();
if (!manualName || !manualMobile || !pin || !city || !flat || !area || !state) {
throw new Error("Please fill all required fields for the new delivery address.");
}
if (!/^\d{10}$/.test(manualMobile)) {
throw new Error("Please enter a valid 10-digit mobile number for delivery.");
}
if (!/^\d{6}$/.test(pin)) {
throw new Error("Please enter a valid 6-digit pincode.");
}

const manualBase = [flat, area, city, state].map(sanitizeValue).filter(Boolean).join(", ");
if (manualBase && pin) finalAddress = `${manualBase} - ${pin}`;
else if (manualBase) finalAddress = manualBase;
else finalAddress = pin;

// Save to customer_addresses table
if (document.getElementById('save-to-profile').checked) {
const { data: { user: sessionUser } } = await supa.auth.getUser();
await blockAdminFromCustomerSite();
if (!sessionUser) {
throw new Error("User not logged in");
}
const { error: addrError } = await supa
  .from('customer_addresses')
  .insert({
    user_id: sessionUser.id,
    address_type: type,
    full_address: `${flat}, ${area}`,
    pincode: pin,
    city: city,
    full_name: manualName || profileName || "Customer",
    is_default: false
  });
if (addrError) throw new Error("Could not save address to profile: " + addrError.message);
}
} else {
finalAddress = sanitizeValue(selectedAddressText);
}

if (!sanitizeValue(finalAddress)) {
throw new Error("Please select a delivery address or add a new delivery address before placing the order.");
}

// ðŸ”¥ GUARANTEE CUSTOMER EXISTS (fix saved address bug)
resolvedCustomerId = await ensureCustomerId(user);
if (!resolvedCustomerId) {
  throw new Error("Customer record missing. Please login again.");
}

// PHASE 2: Create Order
const orderPayload = {
user_id: user.id,
customer_name: (isManualMode ? document.getElementById('new-full-name').value.trim() : "") || profileName || "Customer",
address: finalAddress,
phone_number: (isManualMode && document.getElementById('new-mobile').value.trim()) || profilePhone || user.phone || null,
email: user.email || null,
alt_phone: document.getElementById('cust-alt-phone').value || null,
items: checkoutData.itemsText || checkoutData.name,
total_price: checkoutData.price,
status: 'New',
payment_status: 'Pending',
payment_method: 'Cash',
is_approved: false
};
orderPayload.customer_id = resolvedCustomerId;

let { error: orderError } = await supa.from('orders').insert([orderPayload]);

// If trigger/policy still attempts customers insert, retry once with resolved customer_id from latest order.
if (orderError && /customers/i.test(orderError.message || "")) {
const fallbackCustomerId = await resolveCustomerId(user);
if (fallbackCustomerId) {
resolvedCustomerId = fallbackCustomerId;
orderPayload.customer_id = fallbackCustomerId;
const retry = await supa.from('orders').insert([orderPayload]);
orderError = retry.error;
}
}

if (orderError) {
console.error("Order insert failed:", orderError);
throw orderError;
}

// PHASE 3A: Insert Order Items
// ðŸ”¥ INSERT ORDER ITEMS (THIS WAS MISSING)
let createdOrderId;

// get latest order id of this user (safe way)
const { data: latestOrder } = await supa
  .from("orders")
  .select("id")
  .eq("user_id", user.id)
  .order("created_at", { ascending: false })
  .limit(1)
  .single();

createdOrderId = latestOrder.id;

// If cart checkout
if (checkoutData.cartItems && checkoutData.cartItems.length > 0) {
  const itemsPayload = checkoutData.cartItems.map(item => ({
    order_id: createdOrderId,
    product_id: item.id,
    quantity: item.qty || 1,
    unit_price: item.price
  }));

  const { error: itemsErr } = await supa
    .from("order_items")
    .insert(itemsPayload);

  if (itemsErr) {
    console.error("Order items insert failed", itemsErr);
  }
} else {
  // Single product buy now
  const { error: itemsErr } = await supa
    .from("order_items")
    .insert([{
      order_id: createdOrderId,
      product_id: checkoutData.id,
      quantity: 1,
      unit_price: checkoutData.price
    }]);

  if (itemsErr) console.error(itemsErr);
}

// PHASE 3: Subtract Stock
if (checkoutData.cartItems) {
for (const item of checkoutData.cartItems) {
const { data: p } = await supa.from('products').select('stock').eq('id', item.id).single();
await supa.from('products').update({ stock: p.stock - (item.qty || 1) }).eq('id', item.id);
}
} else if (checkoutData.id !== "CART_ORDER") {
const { data: p } = await supa.from('products').select('stock').eq('id', checkoutData.id).single();
await supa.from('products').update({ stock: p.stock - 1 }).eq('id', checkoutData.id);
}

// PHASE 3B: Insert Inventory Logs
// ðŸ”¥ INVENTORY LOGS (THIS WAS MISSING)
if (checkoutData.cartItems && checkoutData.cartItems.length > 0) {
  for (const item of checkoutData.cartItems) {
    await supa.from("inventory_logs").insert({
      product_id: item.id,
      type: "ORDER_PLACED",
      change: -(item.qty || 1),
      reason: "Customer Order",
      order_id: createdOrderId
    });
  }
} else {
  await supa.from("inventory_logs").insert({
    product_id: checkoutData.id,
    type: "ORDER_PLACED",
    change: -1,
    reason: "Customer Order",
    order_id: createdOrderId
  });
}

// PHASE 4: Success Cleanup
localStorage.removeItem('hc-cart');
localStorage.removeItem('checkout-item');

const msg = `*NEW ORDER*\nItem: ${checkoutData.itemsText || checkoutData.name}\nAddress: ${finalAddress}\nTotal: ?${checkoutData.price}`;
window.open(`https://wa.me/919307760665?text=${encodeURIComponent(msg)}`, '_blank');

location.href = "index.html";

} catch (err) {
const details = [err?.message, err?.details, err?.hint].filter(Boolean).join(" | ");
alert("Error: " + details);
btn.disabled = false;
btn.innerText = "Confirm Order";
}
});

loadCheckoutData();
lucide.createIcons();

document.getElementById('address-select')?.addEventListener('click', (e) => {
e.stopPropagation();
const dropdown = document.getElementById('address-dropdown');
if (dropdown) dropdown.classList.toggle('open');
});

document.addEventListener('click', (e) => {
const dropdown = document.getElementById('address-dropdown');
if (dropdown && !e.target.closest('#address-dropdown')) dropdown.classList.remove('open');
});
</script>
<footer class="site-footer">
  <div class="footer-inner">
    <nav class="footer-nav" aria-label="Footer Navigation">
      <a href="index.html">Home</a>
      <a href="products.html">Products</a>
      <a href="about.html">About</a>
      <a href="contact.html">Contact</a>
      <a href="orders.html">Orders</a>
      <a href="privacy-policy.html">Privacy Policy</a>
    </nav>
    <p class="footer-contact">
      Phone: <a href="tel:+919307760665">+91 9307760665</a> |
      WhatsApp: <a href="https://wa.me/919307760665" target="_blank" rel="noopener">Chat Support</a>
    </p>
    <p class="footer-contact">
      Email: <a href="mailto:hygienicsandcomfort@gmail.com">hygienicsandcomfort@gmail.com</a>
    </p>
    <p class="footer-copy">&copy; 2026 Hygienic &amp; Comfort Co. All rights reserved.</p>
  </div>
</footer>
</body>
</html>




