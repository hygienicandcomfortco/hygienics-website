<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Your Cart | Hygienic & Comfort Co.</title>
    <link rel="icon" type="image/png" href="logo.png">
    <link href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@400;600;700;800&display=swap" rel="stylesheet">
    <script src="https://unpkg.com/lucide@latest"></script>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

    <style>
        :root { 
            --primary: #2563eb; 
            --success: #22c55e;
            --dark: #0f1111; 
            --grey: #565959; 
            --white: #fff; 
            --bg: #f3f3f3;
            --link: #007185;
            --amazon-yellow: #FFD814;
        }

        * { margin: 0; padding: 0; box-sizing: border-box; -webkit-tap-highlight-color: transparent; }
        body { font-family: 'Plus Jakarta Sans', sans-serif; background: var(--bg); color: var(--dark); line-height: 1.5; overflow-x: hidden; }

        /* --- Header (Matching About Page Alignment) --- */
        .main-header { 
            background: var(--white); padding: 15px 5%; border-bottom: 1px solid #f1f5f9; 
            position: sticky; top: 0; z-index: 1000; box-shadow: 0 2px 10px rgba(0,0,0,0.03);
        }
        .header-container { max-width: 1200px; margin: 0 auto; display: flex; flex-direction: column; align-items: left; gap: 12px; }
        .header-top { display: flex; align-items: center; gap: 15px; text-decoration: none; color: inherit; width: 100%; justify-content: left; }
         .header-logo { height: 65px; width: auto; display: block; flex-shrink: 0; }
    
    .brand-text { text-align: left; }
    .brand-text h1 { font-size: 1.4rem; font-weight: 800; color: var(--dark); margin: 0; line-height: 1.1; }
    .brand-text p { font-size: 0.9rem; color: var(--grey); font-weight: 600; margin: 0; }
        
        .nav-links { display: flex; gap: 20px; align-items: center; width: 100%; justify-content: space-between; border-top: 1px solid #eee; padding-top: 10px; margin-top: 5px;}
        .nav-links a { text-decoration: none; color: var(--link); font-weight: 700; font-size: 0.9rem; }

        /* --- Cart Layout --- */
        .cart-wrapper { max-width: 1150px; margin: 20px auto; display: grid; grid-template-columns: 1fr 320px; gap: 20px; padding: 0 15px; }
        
        .cart-main { background: var(--white); padding: 20px; border-radius: 4px; }
        .cart-title { font-size: 1.75rem; font-weight: 700; border-bottom: 1px solid #ddd; padding-bottom: 10px; }
        .price-header { text-align: right; font-size: 0.85rem; color: var(--grey); padding: 5px 0; border-bottom: 1px solid #eee; margin-bottom: 10px; display: block; }

        /* --- Cart Items --- */
        .cart-item { display: flex; gap: 15px; padding: 20px 0; border-bottom: 1px solid #eee; position: relative; }
        .item-img-box { width: 120px; height: 120px; flex-shrink: 0; cursor: pointer; }
        .item-img-box img { width: 100%; height: 100%; object-fit: contain; }

        .item-details { flex: 1; display: flex; flex-direction: column; }
        .item-name { font-size: 1.1rem; font-weight: 700; color: var(--link); text-decoration: none; margin-bottom: 4px; line-height: 1.3; }
        .item-name:hover { color: #c45500; text-decoration: underline; }
        
        .stock-status { font-size: 0.8rem; font-weight: 700; margin-bottom: 5px; }
        .in-stock { color: #007600; }
        .low-stock { color: #b12704; }

        .item-actions { display: flex; align-items: center; gap: 10px; margin-top: 10px; flex-wrap: wrap; }
        
        .qty-box { display: flex; align-items: center; background: #F0F2F2; border: 1px solid #D5D9D9; border-radius: 8px; box-shadow: 0 2px 5px rgba(15,17,17,.15); }
        .qty-btn { border: none; background: transparent; padding: 4px 10px; cursor: pointer; font-size: 1.1rem; }
        .qty-val { padding: 0 8px; font-weight: 700; border-left: 1px solid #D5D9D9; border-right: 1px solid #D5D9D9; font-size: 0.85rem; }

        .action-link { color: var(--link); font-size: 0.8rem; cursor: pointer; border-left: 1px solid #ddd; padding-left: 10px; }
        .action-link:first-of-type { border: none; padding-left: 0; }
        .action-link:hover { text-decoration: underline; color: #c45500; }

        .item-price-col { font-size: 1.2rem; font-weight: 800; text-align: right; min-width: 80px; }

        /* --- Right Sidebar (Subtotal) --- */
        .cart-sidebar { background: var(--white); padding: 20px; border-radius: 4px; height: fit-content; }
        .subtotal-text { font-size: 1.1rem; margin-bottom: 15px; }
        .subtotal-text b { font-size: 1.3rem; font-weight: 800; }

        .proceed-btn { 
            width: 100%; background: var(--amazon-yellow); border: 1px solid #FCD200; 
            border-radius: 20px; padding: 12px; font-weight: 600; cursor: pointer; 
            box-shadow: 0 2px 5px rgba(213,217,217,.5); font-size: 0.95rem;
        }
        .proceed-btn:hover { background: #F7CA00; }

        /* --- Modal --- */
        .modal-overlay { position: fixed; inset: 0; background: rgba(0,0,0,0.6); display: none; align-items: center; justify-content: center; z-index: 2000; backdrop-filter: blur(8px); }
        .modal-content { background: white; width: 90%; max-width: 400px; padding: 25px; border-radius: 8px; }
        .styled-input { width: 100%; padding: 12px; border: 1px solid #888; border-radius: 3px; margin-top: 5px; margin-bottom: 15px; outline: none; }

        /* --- Mobile Friendly --- */
        @media (max-width: 768px) {
            .cart-wrapper { grid-template-columns: 1fr; }
            .cart-sidebar { order: -1; }
            .item-price-col { position: absolute; top: 20px; right: 0; font-size: 1rem; }
            .price-header { display: none; }
            .item-img-box { width: 90px; height: 90px; }
            .brand-text h1 { font-size: 1.1rem; }
            .header-logo { height: 50px; }
        }
    </style>
</head>
<body>

<header class="main-header">
    <div class="header-container">
        <a href="index.html" class="header-top">
            <img src="logo.png" alt="Logo" class="header-logo">
            <div class="brand-text">
                <h1>Hygienic & Comfort Co.</h1>
                <p>Care, Comfort & Hygiene for Every Age</p>
            </div>
        </a>
        <nav class="nav-links">
            <a href="products.html">Back to Shop</a>
            <span id="header-total-display" style="font-weight: 800; color: var(--dark);"></span>
        </nav>
    </div>
</header>

<div class="cart-wrapper">
    <main class="cart-main">
        <h2 class="cart-title">Shopping Cart</h2>
        <span class="price-header">Price</span>
        <div id="cart-items-container"></div>
        
        <div id="saved-section" style="margin-top: 40px; border-top: 2px solid #eee; padding-top: 20px; display: none;">
            <h3 style="font-size: 1.3rem; margin-bottom: 15px;">Saved for later</h3>
            <div id="saved-items-container"></div>
        </div>
    </main>

    <aside class="cart-sidebar" id="summary-section">
        <div class="subtotal-text" id="subtotal-display">
            Subtotal (0 items): <b>â‚¹0</b>
        </div>
        <button onclick="openModal()" class="proceed-btn" id="proceed-btn">Proceed to Checkout</button>
    </aside>
</div>

<div class="modal-overlay" id="checkout-modal">
    <div class="modal-content">
        <h3 style="margin-bottom:15px; font-weight: 800;">Customer Details</h3>
        <form onsubmit="handleFormSubmit(event)">
            <label style="font-size:0.85rem; font-weight:700;">Full Name</label>
            <input type="text" id="cust-name" class="styled-input" required placeholder="Enter your name">
            
            <label style="font-size:0.85rem; font-weight:700;">WhatsApp Number</label>
            <div style="display:flex; border:1px solid #888; border-radius:3px; overflow:hidden; margin-bottom:15px;">
                <span style="background:#eee; padding:12px; font-weight:700;">+91</span>
                <input type="tel" id="cust-phone" style="border:none; outline:none; padding:12px; flex:1;" required pattern="[0-9]{10}" maxlength="10">
            </div>

            <button type="submit" id="confirm-btn" class="proceed-btn" style="background:#22c55e; color:white; border:none;">Confirm Order</button>
            <button type="button" onclick="closeModal()" style="width:100%; background:none; border:none; color:var(--link); margin-top:10px; cursor:pointer; font-weight: 700;">Cancel</button>
        </form>
    </div>
</div>

<script>
    const supa = supabase.createClient(
        "https://uhkheprfbxxwuojswyht.supabase.co",
        "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InVoa2hlcHJmYnh4d3VvanN3eWh0Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3Njc1MjQ4NTMsImV4cCI6MjA4MzEwMDg1M30.sm7ZhqVDWWckAolZN_7p3cGMaK0_aOnwgQcPXnUA-Es"
    );

    let cart = JSON.parse(localStorage.getItem('hc-cart') || '[]');
    let saved = JSON.parse(localStorage.getItem('hc-saved') || '[]');

    function renderCart() {
        const container = document.getElementById('cart-items-container');
        const savedContainer = document.getElementById('saved-items-container');
        const subtotalDisplay = document.getElementById('subtotal-display');
        const headerTotal = document.getElementById('header-total-display');

        if (!cart.length) {
            container.innerHTML = `<div style="padding:40px; text-align:center;"><h3>Your cart is empty</h3><br><a href="products.html" class="action-link" style="font-size:1rem">Shop today's deals</a></div>`;
            document.getElementById('summary-section').style.display = 'none';
            headerTotal.innerText = "";
        } else {
            document.getElementById('summary-section').style.display = 'block';
            let total = 0, count = 0;
            container.innerHTML = cart.map((item, i) => {
                const qty = item.qty || 1;
                total += item.price * qty;
                count += qty;
                const isLow = item.stock > 0 && item.stock <= 3;
                return `
                <div class="cart-item">
                    <div class="item-img-box" onclick="location.href='products.html?id=${item.id}'"><img src="${item.images?.[0] || 'logo.png'}"></div>
                    <div class="item-details">
                        <a href="products.html?id=${item.id}" class="item-name">${item.name}</a>
                        <div class="stock-status ${item.stock > 0 ? (isLow ? 'low-stock' : 'in-stock') : 'low-stock'}">
                            ${item.stock > 0 ? (isLow ? `Only ${item.stock} left in stock - order soon.` : 'In Stock') : 'Out of Stock'}
                        </div>
                        <div class="item-actions">
                            <div class="qty-box">
                                <button class="qty-btn" onclick="updateQty(${i}, -1)">-</button>
                                <span class="qty-val">${qty}</span>
                                <button class="qty-btn" onclick="updateQty(${i}, 1)">+</button>
                            </div>
                            <span class="action-link" onclick="removeItem(${i})">Delete</span>
                            <span class="action-link" onclick="saveLater(${i})">Save for later</span>
                            <span class="action-link" onclick="shareItem('${item.id}', '${item.name}')">Share</span>
                        </div>
                    </div>
                    <div class="item-price-col">â‚¹${(item.price * qty).toLocaleString()}</div>
                </div>`;
            }).join('');
            
            const totalStr = `â‚¹${total.toLocaleString()}`;
            subtotalDisplay.innerHTML = `Subtotal (${count} items): <b>${totalStr}</b>`;
            headerTotal.innerText = `Total: ${totalStr}`;
        }

        // Render Saved Items
        if (saved.length) {
            document.getElementById('saved-section').style.display = 'block';
            savedContainer.innerHTML = saved.map((item, i) => `
                <div class="cart-item" style="opacity: 0.8">
                    <div class="item-img-box" style="width: 80px; height: 80px;"><img src="${item.images?.[0] || 'logo.png'}"></div>
                    <div class="item-details">
                        <span class="item-name" style="font-size: 0.95rem">${item.name}</span>
                        <div class="item-actions">
                            <span class="action-link" onclick="moveToCart(${i})">Move to cart</span>
                            <span class="action-link" onclick="deleteSaved(${i})">Delete</span>
                        </div>
                    </div>
                </div>`).join('');
        } else {
            document.getElementById('saved-section').style.display = 'none';
        }
        lucide.createIcons();
    }

    async function updateQty(index, change) {
        const item = cart[index];
        const newQty = (item.qty || 1) + change;
        if (newQty < 1) return;

        // Stock check against database
        const { data: p } = await supa.from('products').select('stock').eq('id', item.id).single();
        if (p && newQty > p.stock) {
            alert(`Only ${p.stock} units available in stock.`);
            return;
        }
        cart[index].qty = newQty;
        save();
    }

    function removeItem(i) { cart.splice(i, 1); save(); }
    function saveLater(i) { saved.push(cart.splice(i, 1)[0]); save(); }
    function moveToCart(i) { cart.push(saved.splice(i, 1)[0]); save(); }
    function deleteSaved(i) { saved.splice(i, 1); save(); }

    function shareItem(id, name) {
        const url = `${window.location.origin}/products.html?id=${id}`;
        if (navigator.share) {
            navigator.share({ title: name, url: url }).catch(() => {});
        } else {
            navigator.clipboard.writeText(url);
            alert("Product link copied!");
        }
    }

    function save() {
        localStorage.setItem('hc-cart', JSON.stringify(cart));
        localStorage.setItem('hc-saved', JSON.stringify(saved));
        renderCart();
    }

    function openModal() { document.getElementById('checkout-modal').style.display = 'flex'; }
    function closeModal() { document.getElementById('checkout-modal').style.display = 'none'; }

    async function handleFormSubmit(e) {
        e.preventDefault();
        const btn = document.getElementById('confirm-btn');
        btn.disabled = true; btn.innerText = "Syncing Inventory...";

        try {
            const name = document.getElementById('cust-name').value.trim();
            const phone = document.getElementById('cust-phone').value.trim();
            const total = cart.reduce((acc, i) => acc + (i.price * i.qty), 0);

            // 1. Database Entry
            const { error } = await supa.from('orders').insert([{
                customer_name: name, phone_number: "+91" + phone,
                items: cart.map(i => `${i.name} (x${i.qty})`).join(', '),
                total_price: total, status: 'New'
            }]);
            if (error) throw error;

            // 2. Decrement Stock
            for (const item of cart) {
                const { data: p } = await supa.from('products').select('stock').eq('id', item.id).single();
                await supa.from('products').update({ stock: Math.max(0, p.stock - item.qty) }).eq('id', item.id);
            }

            // 3. WhatsApp Redirect
            const msg = `*New Order - Hygienic & Comfort Co.*\nðŸ‘¤ Name: ${name}\nðŸ“ž Phone: +91 ${phone}\nðŸ’° Total: â‚¹${total.toLocaleString()}\n\n*Items:*\n` + cart.map(i => `â€¢ ${i.name} (x${i.qty})`).join('\n');
            window.open(`https://wa.me/919307760665?text=${encodeURIComponent(msg)}`, '_blank');

            localStorage.removeItem('hc-cart');
            window.location.href = 'index.html';
        } catch (err) {
            alert("Order Error: " + err.message);
            btn.disabled = false; btn.innerText = "Confirm Order";
        }
    }

    renderCart();
</script>
</body>
</html>
