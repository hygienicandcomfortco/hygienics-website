<!DOCTYPE html>

<html lang="en">
<link rel="icon" type="image/png" href="logo.png">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Your Cart | Hygienic & Comfort Co.</title>
<link href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@400;600;700;800&display=swap" rel="stylesheet">
<script src="https://unpkg.com/lucide@latest"></script>
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

<style>
    :root { --primary:#2563eb; --dark:#1e293b; --grey:#64748b; --white:#fff; --bg:#f8fafc; }
    * { margin:0; padding:0; box-sizing:border-box; }

    body { font-family:'Plus Jakarta Sans',sans-serif; background:var(--bg); color:var(--dark); padding-bottom:120px; }

    .main-header { background:white; padding:12px 5%; border-bottom:1px solid #f1f5f9; display:flex; justify-content:space-between; align-items:center; position:sticky; top:0; z-index:1000; box-shadow:0 2px 10px rgba(0,0,0,.03); }

    .logo-area { display:flex; align-items:center; gap:12px; text-decoration:none; color:inherit; }

    .header-logo { height:45px; width:auto; }

    .brand-text h1 { font-size:1.1rem; font-weight:800; letter-spacing:-.5px; }

    .cart-container { max-width:800px; margin:30px auto; padding:0 5%; }

    .cart-item { background:white; padding:20px; border-radius:18px; display:flex; gap:20px; margin-bottom:15px; border:1px solid #f1f5f9; align-items:center; box-shadow:0 4px 6px -1px rgba(0,0,0,.05); }

    .cart-img { width:70px; height:70px; object-fit:contain; }

    .footer-summary { position:fixed; bottom:0; left:0; width:100%; background:white; padding:25px 5%; border-top:1px solid #f1f5f9; box-shadow:0 -10px 25px rgba(0,0,0,.05); }

    .checkout-btn { width:100%; max-width:400px; background:#22c55e; color:white; padding:18px; border-radius:15px; font-weight:800; border:none; cursor:pointer; display:flex; justify-content:center; gap:10px; margin:0 auto; }

    .modal-overlay { position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,.6); display:none; align-items:center; justify-content:center; z-index:2000; backdrop-filter:blur(4px); }

    .modal-content { background:white; width:90%; max-width:400px; padding:30px; border-radius:20px; }

    .phone-input { display:flex; border:1px solid #e2e8f0; border-radius:10px; overflow:hidden; margin-top:5px; }

    .prefix { background:#f1f5f9; padding:12px; font-weight:800; border-right:1px solid #e2e8f0; }

    .phone-input input { flex:1; border:none; padding:12px; outline:none; }
</style>
</head>

<body>

<header class="main-header">
    <a href="index.html" class="logo-area">
        <img src="logo.png" alt="Logo" class="header-logo">
        <div class="brand-text"><h1>Hygienic & Comfort Co.</h1></div>
    </a>
    <a href="products.html" style="text-decoration:none; color:var(--primary); font-weight:700;">Back to Shop</a>
</header>

<main class="cart-container">
    <h2 style="font-weight:800; margin-bottom:25px;">Final Checkout</h2>
    <div id="cart-items"></div>
</main>

<div class="footer-summary" id="summary-section">
    <div style="max-width:800px; margin:0 auto; display:flex; justify-content:space-between; align-items:center; margin-bottom:15px;">
        <span style="font-weight:800; font-size:1.2rem">Total: <span id="grand-total">â‚¹0</span></span>
    </div>
    <button onclick="openModal()" class="checkout-btn"><i data-lucide="shopping-bag"></i> Proceed to Checkout</button>
</div>

<div class="modal-overlay" id="checkout-modal">
    <div class="modal-content">
        <h3 style="font-weight:800; margin-bottom:15px;">Customer Details</h3>
    <form onsubmit="handleFormSubmit(event)">
        <label style="font-weight:700; font-size:.8rem">Full Name</label>
        <input type="text" id="cust-name" required style="width:100%; padding:12px; border:1px solid #e2e8f0; border-radius:10px; margin-bottom:15px;">

        <label style="font-weight:700; font-size:.8rem">WhatsApp Number</label>
        <div class="phone-input">
            <span class="prefix">+91</span>
            <input type="tel" id="cust-phone" required pattern="[0-9]{10}" maxlength="10">
        </div>

        <button type="submit" id="confirm-btn" class="checkout-btn" style="width:100%; margin-top:20px;">Confirm & WhatsApp</button>
        <button type="button" onclick="closeModal()" style="width:100%; background:none; border:none; color:var(--grey); margin-top:15px; cursor:pointer">Cancel</button>
    </form>
</div>

</div>

<script>
const supa = supabase.createClient(
    "https://uhkheprfbxxwuojswyht.supabase.co",
    "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InVoa2hlcHJmYnh4d3VvanN3eWh0Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3Njc1MjQ4NTMsImV4cCI6MjA4MzEwMDg1M30.sm7ZhqVDWWckAolZN_7p3cGMaK0_aOnwgQcPXnUA-Es"
);

let cart = JSON.parse(localStorage.getItem('hc-cart') || '[]');

function renderCart() {
    const container = document.getElementById('cart-items');

    if (!cart.length) {
        container.innerHTML = `<p style="text-align:center; padding:40px;">Your cart is empty.</p>`;
        document.getElementById('summary-section').style.display = 'none';
        return;
    }

    let total = 0;

    container.innerHTML = cart.map((item, i) => {
        const qty = item.qty || 1;
        const price = item.price || 0;
        total += price * qty;

        return `
        <div class="cart-item">
            <img src="${item.images?.[0] || 'logo.png'}" class="cart-img">
            <div style="flex:1">
                <h4 style="font-weight:700">${item.name}</h4>
                <p style="font-weight:800">â‚¹${price.toLocaleString()}</p>
                <div style="margin-top:5px">Quantity: ${qty}</div>
            </div>
            <button onclick="removeItem(${i})" style="border:none; background:none; color:#ef4444; cursor:pointer"><i data-lucide="trash-2"></i></button>
        </div>`;
    }).join('');

    document.getElementById('grand-total').innerText = `â‚¹${total.toLocaleString()}`;
    lucide.createIcons();
}

function removeItem(i) {
    cart.splice(i, 1);
    localStorage.setItem('hc-cart', JSON.stringify(cart));
    renderCart();
}

function openModal() { document.getElementById('checkout-modal').style.display = 'flex'; }
function closeModal() { document.getElementById('checkout-modal').style.display = 'none'; }

async function handleFormSubmit(e) {
    e.preventDefault();
    const btn = document.getElementById('confirm-btn');
    btn.disabled = true;
    btn.innerText = "Syncing Admin Panel...";

    try {
        const name = document.getElementById('cust-name').value.trim();
        const phone = document.getElementById('cust-phone').value.trim();
        const totalText = document.getElementById('grand-total').innerText;

        const itemsString = cart.map(i => `${i.name} (x${i.qty || 1})`).join(', ');
        const cleanTotal = parseInt(totalText.replace(/[^0-9]/g, ''));

        const { error } = await supa.from('orders').insert([{
            customer_name: name,
            phone_number: "+91" + phone,
            items: itemsString,
            total_price: cleanTotal,
            status: 'New'
        }]);

        if (error) throw error;

        const msg =
`*New Order â€” Hygienic & Comfort Co.*
ðŸ‘¤ Name: ${name}
ðŸ“ž Phone: +91 ${phone}
ðŸ’° Total: ${totalText}

ðŸ§º Items:
${cart.map(i => `â€¢ ${i.name} (x${i.qty || 1})`).join('\n')}
`;

        window.open(`https://wa.me/919307760665?text=${encodeURIComponent(msg)}`, '_blank');
        localStorage.removeItem('hc-cart');
        window.location.href = 'index.html';

    } catch (err) {
        alert("Error: " + err.message);
        btn.disabled = false;
        btn.innerText = "Confirm & WhatsApp";
    }
}

renderCart();
lucide.createIcons();
</script>

</body>
</html>
