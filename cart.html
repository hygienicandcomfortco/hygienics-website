<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no">

<title>Your Cart | Hygienic & Comfort Co. - Review Your Order</title>
<meta name="description" content="View your shopping cart at Hygienic & Comfort Co. Review your selected baby and adult hygiene products before secure checkout and WhatsApp ordering.">
<link rel="canonical" href="https://hygienicandcomfortco.shop/cart.html" />

<link rel="icon" type="image/png" href="logo.png">
<link href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@400;600;700;800&display=swap" rel="stylesheet">
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

<style>
:root {--yellow:#FFD814;--yellow-b:#FCD200;--blue:#007185;--dark:#111;--bg:#f3f3f3;--white:#fff;--grey:#565959;}
*{margin:0;padding:0;box-sizing:border-box;font-family:'Plus Jakarta Sans',sans-serif; -webkit-tap-highlight-color: transparent;}
body{background:var(--bg);color:var(--dark); overflow-x: hidden;}

/* --- Fixed One-Line Header --- */
header {
  background: var(--white);
  padding: 10px 15px;
  border-bottom: 1px solid #ddd;
  position: sticky;
  top: 0;
  z-index: 1000;
}
.head-container {
  max-width: 1150px;
  margin: auto;
  display: flex;
  align-items: center;
  justify-content: space-between;
}
.logo-link {
  display: flex;
  align-items: center;
  gap: 8px;
  text-decoration: none;
  color: inherit;
  flex: 1;
  min-width: 0; 
}
header img { height: 35px; flex-shrink: 0; }
header h1 { 
  font-size: 0.9rem; 
  font-weight: 800; 
  white-space: nowrap; 
  overflow: hidden; 
  text-overflow: ellipsis; 
}
.back-link {
  color: var(--blue);
  font-weight: 700;
  font-size: 0.8rem;
  text-decoration: none;
  white-space: nowrap;
  margin-left: 10px;
}

.page {
  max-width: 1150px;
  margin: 10px auto;
  padding: 0 10px;
  display: flex;
  flex-direction: column;
  gap: 12px;
}

/* --- Summary Box --- */
.summary-card {
  background: var(--white);
  padding: 15px;
  border-radius: 8px;
  box-shadow: 0 1px 3px rgba(0,0,0,.1);
}
.sum-row { display: flex; justify-content: space-between; margin-bottom: 4px; font-size: 0.9rem; }
.sum-total { font-weight: 800; font-size: 1.15rem; color: #b12704; margin-top: 5px; }
.checkout-btn {
  width: 100%;
  margin-top: 12px;
  padding: 12px;
  border-radius: 25px;
  background: var(--yellow);
  border: 1px solid var(--yellow-b);
  font-size: 0.95rem;
  font-weight: 700;
  cursor: pointer;
}

/* --- Cart Items --- */
.cart-main { background: var(--white); border-radius: 8px; padding: 15px; }
.cart-title { font-size: 1.3rem; font-weight: 800; margin-bottom: 10px; border-bottom: 1px solid #eee; padding-bottom: 8px; }
.price-label { text-align: right; font-size: 0.75rem; color: var(--grey); margin-bottom: 5px; display: block; }

.cart-item {
  display: flex;
  gap: 12px;
  padding: 15px 0;
  border-bottom: 1px solid #eee;
}
.cart-img { width: 90px; height: 90px; object-fit: contain; flex-shrink: 0; background: #fff; }
.item-content { flex: 1; min-width: 0; }
.name-price-flex { display: flex; justify-content: space-between; align-items: flex-start; gap: 8px; }
.item-name { font-weight: 700; font-size: 0.9rem; color: var(--dark); line-height: 1.2; text-decoration: none; }
.item-price { font-size: 1.05rem; font-weight: 800; white-space: nowrap; }

.stock-msg { font-size: 0.75rem; font-weight: 700; margin: 4px 0; }
.red { color: #B12704; } .green { color: #007600; }

.action-row { margin-top: 12px; display: flex; gap: 10px; flex-wrap: wrap; align-items: center; }
.qty-ctrl { display: flex; background: #F0F2F2; border: 1px solid #D5D9D9; border-radius: 8px; overflow: hidden; }
.qty-ctrl button { padding: 5px 12px; border: none; background: none; cursor: pointer; font-size: 1.1rem; font-weight: bold; }
.qty-ctrl span { padding: 5px 8px; border-inline: 1px solid #D5D9D9; font-weight: 700; font-size: 0.85rem; background: #fff; }
.link-action { cursor: pointer; font-size: 0.75rem; color: var(--blue); border-left: 1px solid #ddd; padding-left: 10px; }
.link-action:first-of-type { border-left: none; padding-left: 0; }

/* Desktop View */
@media(min-width: 860px) {
  .page { display: grid; grid-template-columns: 1fr 320px; gap: 20px; margin-top: 20px; }
  .summary-card { order: 2; position: sticky; top: 90px; }
  .cart-main { order: 1; padding: 25px; }
  header img { height: 40px; }
  header h1 { font-size: 1.2rem; }
  .cart-img { width: 140px; height: 140px; }
}

/* Mobile Priority */
@media(max-width: 859px) {
  .summary-card { order: 1; }
  .cart-main { order: 2; }
}
</style>
</head>

<body>
<header>
  <div class="head-container">
    <a href="index.html" class="logo-link">
      <img src="logo.png" alt="Hygienic & Comfort Co. Logo">
      <h1>Hygienic & Comfort Co.</h1>
    </a>
    <a href="products.html" class="back-link">Back to Shop</a>
  </div>
</header>

<div class="page">
  <aside class="summary-card" id="summary-section">
    <div class="sum-row"><span id="items-count">Subtotal (0 items)</span><b id="sub-total">₹0</b></div>
    <div class="sum-row sum-total"><span>Total</span><b id="grand-total">₹0</b></div>
    <button type="button" class="checkout-btn" onclick="openModal()">Proceed to Checkout</button>
  </aside>

  <section class="cart-main">
    <h2 class="cart-title">Shopping Cart</h2>
    <span class="price-label">Price</span>
    <div id="cart-list"></div>

    <div id="saved-section" style="display:none; margin-top: 30px; border-top: 2px solid #eee; padding-top: 15px;">
      <h3 style="font-size: 1rem; margin-bottom: 10px;">Saved for later</h3>
      <div id="saved-list"></div>
    </div>
  </section>
</div>

<div id="checkout-modal" style="position:fixed;inset:0;background:rgba(0,0,0,.6);display:none;justify-content:center;align-items:center;backdrop-filter:blur(4px); z-index: 2000;">
  <div style="background:#fff;padding:25px;border-radius:12px;width:92%;max-width:380px;">
    <h3 style="font-weight:800;margin-bottom:15px; font-size: 1.2rem;">Order Details</h3>
    <form onsubmit="handleOrder(event)">
      <label style="font-size: 0.8rem; font-weight: 700;">Full Name</label>
      <input type="text" id="cust-name" required style="width:100%;padding:12px;margin:5px 0 15px;border:1px solid #ccc;border-radius:6px; outline: none;">
      
      <label style="font-size: 0.8rem; font-weight: 700;">WhatsApp Number</label>
      <div style="display:flex;border:1px solid #ccc;border-radius:6px;margin: 5px 0 20px; overflow: hidden;">
        <span style="padding:12px;background:#f3f3f3;font-weight:700;">+91</span>
        <input type="tel" id="cust-phone" maxlength="10" pattern="[0-9]{10}" required style="flex:1;border:none;padding:12px; outline: none;">
      </div>
      
      <button type="submit" class="checkout-btn" style="background:#22c55e; border:none; color:#fff; margin-top:0;">Confirm & Order</button>
      <p onclick="closeModal()" style="margin-top:15px;text-align:center;color:var(--blue);font-weight:700;cursor:pointer;font-size:.85rem;">Cancel</p>
    </form>
  </div>
</div>

<script>
const supa = supabase.createClient(
  "https://uhkheprfbxxwuojswyht.supabase.co",
  "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InVoa2hlcHJmYnh4d3VvanN3eWh0Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3Njc1MjQ4NTMsImV4cCI6MjA4MzEwMDg1M30.sm7ZhqVDWWckAolZN_7p3cGMaK0_aOnwgQcPXnUA-Es"
);

let cart = JSON.parse(localStorage.getItem('hc-cart')||'[]');
let saved = JSON.parse(localStorage.getItem('hc-saved')||'[]');

function updateStorage() {
  localStorage.setItem('hc-cart', JSON.stringify(cart));
  localStorage.setItem('hc-saved', JSON.stringify(saved));
  renderUI();
}

function renderUI() {
  const cartList = document.getElementById('cart-list');
  const savedList = document.getElementById('saved-list');
  const savedSection = document.getElementById('saved-section');

  if(!cart.length && !saved.length) {
    cartList.innerHTML = `<div style="padding:40px; text-align:center;"><p>Your cart is empty.</p></div>`;
    document.getElementById('summary-section').style.display = 'none';
    savedSection.style.display = 'none';
    return;
  }

  document.getElementById('summary-section').style.display = cart.length ? 'block' : 'none';
  let subtotal = 0, count = 0;

  cartList.innerHTML = cart.map((p, i) => {
    const qty = p.qty || 1;
    subtotal += p.price * qty;
    count += qty;
    const isLow = p.stock > 0 && p.stock <= 3;
    return `
    <div class="cart-item">
      <img class="cart-img" src="${p.images?.[0]||'logo.png'}" onclick="location.href='products.html?id=${p.id}'" alt="${p.name}">
      <div class="item-content">
        <div class="name-price-flex">
          <a href="products.html?id=${p.id}" class="item-name">${p.name}</a>
          <span class="item-price">₹${(p.price * qty).toLocaleString()}</span>
        </div>
        <p class="stock-msg ${isLow ? 'red' : 'green'}">
          ${p.stock <= 0 ? 'Out of Stock' : (isLow ? `Only ${p.stock} left in stock` : 'In Stock')}
        </p>
        <div class="action-row">
          <div class="qty-ctrl">
            <button type="button" onclick="changeQty(${i}, -1)">-</button>
            <span>${qty}</span>
            <button type="button" onclick="changeQty(${i}, 1)">+</button>
          </div>
          <span class="link-action" onclick="deleteItem(${i})">Delete</span>
          <span class="link-action" onclick="saveItem(${i})">Save</span>
          <span class="link-action" onclick="shareItem('${p.id}','${p.name}')">Share</span>
        </div>
      </div>
    </div>`;
  }).join('');

  if(saved.length) {
    savedSection.style.display = 'block';
    savedList.innerHTML = saved.map((p, i) => `
      <div class="cart-item" style="opacity: 0.7; padding: 10px 0;">
        <img class="cart-img" src="${p.images?.[0]||'logo.png'}" style="width: 60px; height: 60px;" alt="${p.name}">
        <div class="item-content">
          <span class="item-name" style="font-size: 0.85rem;">${p.name}</span>
          <div class="action-row">
            <span class="link-action" onclick="moveToCart(${i})">Move to cart</span>
            <span class="link-action" onclick="deleteSaved(${i})">Delete</span>
          </div>
        </div>
      </div>`).join('');
  } else { savedSection.style.display = 'none'; }

  document.getElementById('items-count').innerText = `Subtotal (${count} items)`;
  document.getElementById('sub-total').innerText = `₹${subtotal.toLocaleString()}`;
  document.getElementById('grand-total').innerText = `₹${subtotal.toLocaleString()}`;
}

async function changeQty(idx, delta) {
  const item = cart[idx];
  const newQty = (item.qty || 1) + delta;
  if(newQty < 1) return;

  const {data} = await supa.from('products').select('stock').eq('id', item.id).maybeSingle();
  if(!data || newQty > data.stock) return alert(`Limit: ${data ? data.stock : 0} available.`);
  
  cart[idx].qty = newQty;
  updateStorage();
}

function deleteItem(i) { cart.splice(i, 1); updateStorage(); }
function saveItem(i) { saved.push(cart.splice(i, 1)[0]); updateStorage(); }
function deleteSaved(i) { saved.splice(i, 1); updateStorage(); }
function moveToCart(i) { cart.push(saved.splice(i, 1)[0]); updateStorage(); }

function shareItem(id, name) {
  const url = `${location.origin}/products.html?id=${id}`;
  if(navigator.share) navigator.share({title: name, url: url}).catch(()=>{});
  else { 
      const dummy = document.createElement('input');
      document.body.appendChild(dummy);
      dummy.value = url;
      dummy.select();
      document.execCommand('copy');
      document.body.removeChild(dummy);
      alert("Product link copied to clipboard!"); 
  }
}

function openModal() { document.getElementById('checkout-modal').style.display='flex'; }
function closeModal() { document.getElementById('checkout-modal').style.display='none'; }

async function handleOrder(e) {
  e.preventDefault();
  const btn = e.target.querySelector('button');
  btn.disabled = true; btn.innerText = 'Processing...';

  const name = document.getElementById('cust-name').value.trim();
  const phone = document.getElementById('cust-phone').value.trim();

  try {
    for(const item of cart) {
      const {data} = await supa.from('products').select('stock').eq('id', item.id).maybeSingle();
      if(!data || item.qty > data.stock) throw new Error(`${item.name} is out of stock!`);
    }

    const total = cart.reduce((t, x) => t + x.price * x.qty, 0);
    await supa.from('orders').insert([{
      customer_name: name, phone_number: "+91" + phone,
      items: cart.map(x => `${x.name} (x${x.qty})`).join(', '),
      total_price: total, status: 'New'
    }]);

    for(const item of cart) {
      const {data} = await supa.from('products').select('stock').eq('id', item.id).maybeSingle();
      await supa.from('products').update({stock: data.stock - item.qty}).eq('id', item.id);
    }

    const msg = `*New Order*\nName: ${name}\nPhone: +91 ${phone}\nTotal: ₹${total.toLocaleString()}\n\nItems:\n` + cart.map(x => `• ${x.name} x${x.qty}`).join('\n');
    window.open(`https://wa.me/919307760665?text=${encodeURIComponent(msg)}`, '_blank');

    localStorage.removeItem('hc-cart');
    location.href='index.html';
  } catch(err) {
    alert(err.message);
    btn.disabled = false; btn.innerText = 'Confirm & Order';
  }
}

renderUI();
</script>
</body>
</html>
